In order to control and stabilize the segway a the communication with the accelerometer/gyroscope must be established.
This must data received must then be processed in order to control the motors according to the segways position.



\begin{figure}[H]
\centering

\begin{tikzpicture}[node distance=1cm]
% FPGA border
\node[rectangle,draw,minimum width=11cm, minimum height=7cm, dashed, name=FPGA]  {};

% used to align the insides of FPGA
\node[rectangle,minimum width=5cm, minimum height=5cm, name=FPGAaligne] {};

% components of FPGA
\node[rectangle,draw,minimum width=3cm, minimum height=1cm, name=pid] at (FPGAaligne.-135) {PID};
\node[rectangle,draw,minimum width=3cm, minimum height=1cm, name=communiction] at (FPGAaligne.45) {SPI Module};
\node[rectangle,draw,minimum width=3cm, minimum height=1cm, name=mc] at (FPGAaligne.-45) {Motor Control};
\node[rectangle,draw,minimum width=3cm, minimum height=1cm, name=filter] at (FPGAaligne.180) {Filter};
\node[rectangle,draw,minimum width=3cm, minimum height=1cm, name=segway] at (FPGAaligne.135) {Segway Control};

% nodes outside FPGA
%\node [left=of utos,name=pc] {PC};
\node [right=of communiction,name=spi] at (5,2.5) {IMU};
%\node [left=of color,name=rgb] {RGB(2:0)};
\node [right=of mc,name=motor] at (5,-2.5){DC Motors};

% arrows inside FPGA
\draw[<->] (segway) -- node[] {} (communiction) ;
\draw[->] (segway) -- node[left] {8 bit} (filter) ;
\draw[->] (filter) --  node[left] {8 bit} (pid) ;
\draw[->] (segway) -- node[above right] {9 bit} (mc) ;
\draw[->] (pid) --(-4.5,-2.5)--(-4.5,2.5)-- node[below left] {9 bit} (segway) ;
 
% arrows connected to the outside of FPGA
\draw[<->] (spi) -- node[] {} (communiction) ;
\draw[<->] (mc) -- node[] {} (motor) ;
%\draw[->] (adc) to[out=180, in=0] node[] {} (ad) ;
%\draw[->] (color) to[out=180, in=0] node[] {} (rgb) ;
%\draw[->] (mc) to[out=0, in=180] node[] {} (servo) ;
\end{tikzpicture}

\caption{Block design of the FPGA.}
\label{fig:fpga_sof_design}
\end{figure}


The designed system is comprised by the modules seen in figure \ref{fig:fpga_sof_design}.
Here the \textit{Segway Control} block is the main part of the system, used to combine the different components into one.
The \textit{SPI Module} takes care of the communication with the accelerometer and gyroscope by sending data to such when asked for by the \textit{Segway Control} module.

Data from such is then send to the \textit{Filter} to predict an angle.
From here the angle is passed to the \textit{PID} in order to generate a duty cycle which is then passed back to the main module, the \textit{Segway Control}.
The \textit{Segway Control} hence also takes care to set the right ports on the H-bridges, through the \textit{Motor Control} unit, depending on the speed and direction bit generated by the \textit{PID}.
The five components are explained further throughout this section.
